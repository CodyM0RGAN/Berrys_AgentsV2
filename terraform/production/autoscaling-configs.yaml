apiVersion: v1
kind: ConfigMap
metadata:
  name: autoscaling-config
  namespace: berrys-production
data:
  # Flag to enable/disable auto-scaling (disabled by default for local deployments)
  enable-autoscaling: "false"
  scaling-policy: |
    {
      "default": {
        "minReplicas": 2,
        "maxReplicas": 5,
        "targetCPUUtilizationPercentage": 75,
        "targetMemoryUtilizationPercentage": 80,
        "stabilizationWindowSeconds": 300
      },
      "high-traffic": {
        "minReplicas": 3,
        "maxReplicas": 10,
        "targetCPUUtilizationPercentage": 70,
        "targetMemoryUtilizationPercentage": 75,
        "stabilizationWindowSeconds": 180
      },
      "critical-service": {
        "minReplicas": 4,
        "maxReplicas": 15,
        "targetCPUUtilizationPercentage": 65,
        "targetMemoryUtilizationPercentage": 70,
        "stabilizationWindowSeconds": 120
      }
    }
---
# The following resources are only applied when auto-scaling is enabled
# Comment header to indicate conditional application
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway-hpa
  namespace: berrys-production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 180
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: agent-orchestrator-hpa
  namespace: berrys-production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: agent-orchestrator
  minReplicas: 2
  maxReplicas: 8
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 75
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: agent_processing_queue_length
      target:
        type: AverageValue
        averageValue: 10
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Pods
        value: 2
        periodSeconds: 30
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: model-orchestration-hpa
  namespace: berrys-production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: model-orchestration
  minReplicas: 3
  maxReplicas: 12
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75
  - type: Pods
    pods:
      metric:
        name: model_request_queue_length
      target:
        type: AverageValue
        averageValue: 5
  - type: Pods
    pods:
      metric:
        name: model_request_latency_seconds
      target:
        type: AverageValue
        averageValue: 2
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: tool-integration-hpa
  namespace: berrys-production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: tool-integration
  minReplicas: 2
  maxReplicas: 6
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 75
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Pods
        value: 1
        periodSeconds: 30
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: web-dashboard-hpa
  namespace: berrys-production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: web-dashboard
  minReplicas: 2
  maxReplicas: 6
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 75
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: 500
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Pods
        value: 2
        periodSeconds: 30
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: api-gateway-pdb
  namespace: berrys-production
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: api-gateway
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: model-orchestration-pdb
  namespace: berrys-production
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: model-orchestration
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: agent-orchestrator-pdb
  namespace: berrys-production
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: agent-orchestrator
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: berrys-production-quota
  namespace: berrys-production
spec:
  hard:
    requests.cpu: "24"
    requests.memory: 48Gi
    limits.cpu: "48"
    limits.memory: 96Gi
    pods: "100"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: berrys-production-limits
  namespace: berrys-production
spec:
  limits:
  - default:
      memory: 512Mi
      cpu: 500m
    defaultRequest:
      memory: 256Mi
      cpu: 250m
    type: Container
