{% extends "base.html" %}

{% block title %}Alerts Dashboard{% endblock %}

{% block styles %}
<style>
    .alert-card {
        margin-bottom: 20px;
        border-left: 5px solid;
    }

    .alert-card.info {
        border-left-color: #17a2b8;
    }

    .alert-card.warning {
        border-left-color: #ffc107;
    }

    .alert-card.error {
        border-left-color: #dc3545;
    }

    .alert-card.critical {
        border-left-color: #721c24;
        background-color: #f8d7da;
    }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .alert-actions {
        display: flex;
        gap: 10px;
    }

    .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .config-card {
        margin-bottom: 15px;
    }

    .nav-tabs {
        margin-bottom: 20px;
    }

    .tab-pane {
        padding: 20px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 5px 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4 mb-4">Alerts Dashboard</h1>

    <ul class="nav nav-tabs" id="alertTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button"
                role="tab" aria-controls="active" aria-selected="true">Active Alerts</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button"
                role="tab" aria-controls="history" aria-selected="false">Alert History</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="configurations-tab" data-bs-toggle="tab" data-bs-target="#configurations"
                type="button" role="tab" aria-controls="configurations" aria-selected="false">Alert
                Configurations</button>
        </li>
    </ul>

    <div class="tab-content" id="alertTabsContent">
        <!-- Active Alerts Tab -->
        <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="severityFilter">Severity</label>
                            <select class="form-control" id="severityFilter">
                                <option value="">All</option>
                                <option value="INFO">Info</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="metricTypeFilter">Metric Type</label>
                            <select class="form-control" id="metricTypeFilter">
                                <option value="">All</option>
                                <option value="QUEUE_LENGTH">Queue Length</option>
                                <option value="PROCESSING_TIME">Processing Time</option>
                                <option value="ROUTING_TIME">Routing Time</option>
                                <option value="DELIVERY_TIME">Delivery Time</option>
                                <option value="MESSAGE_COUNT">Message Count</option>
                                <option value="ERROR_RATE">Error Rate</option>
                                <option value="TOPIC_ACTIVITY">Topic Activity</option>
                                <option value="AGENT_ACTIVITY">Agent Activity</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary form-control" id="applyFilters">Apply Filters</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary form-control" id="resetFilters">Reset Filters</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="activeAlerts">
                <!-- Active alerts will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert History Tab -->
        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="historyStartDate">Start Date</label>
                            <input type="datetime-local" class="form-control" id="historyStartDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="historyEndDate">End Date</label>
                            <input type="datetime-local" class="form-control" id="historyEndDate">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="historySeverityFilter">Severity</label>
                            <select class="form-control" id="historySeverityFilter">
                                <option value="">All</option>
                                <option value="INFO">Info</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="acknowledgedFilter">Status</label>
                            <select class="form-control" id="acknowledgedFilter">
                                <option value="">All</option>
                                <option value="true">Acknowledged</option>
                                <option value="false">Unacknowledged</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary form-control" id="applyHistoryFilters">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="alertHistory">
                <!-- Alert history will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            <nav aria-label="Alert history pagination">
                <ul class="pagination justify-content-center" id="historyPagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>
        </div>

        <!-- Alert Configurations Tab -->
        <div class="tab-pane fade" id="configurations" role="tabpanel" aria-labelledby="configurations-tab">
            <div class="d-flex justify-content-between mb-3">
                <h3>Alert Configurations</h3>
                <button class="btn btn-primary" id="createAlertConfig">Create New Alert</button>
            </div>

            <div id="alertConfigurations">
                <!-- Alert configurations will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Alert Configuration Modal -->
<div class="modal fade" id="alertConfigModal" tabindex="-1" aria-labelledby="alertConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertConfigModalLabel">Create Alert Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="alertConfigForm">
                    <input type="hidden" id="alertConfigId">
                    <div class="mb-3">
                        <label for="alertName" class="form-label">Alert Name</label>
                        <input type="text" class="form-control" id="alertName" required>
                    </div>
                    <div class="mb-3">
                        <label for="alertDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="alertDescription" rows="2"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="metricType" class="form-label">Metric Type</label>
                            <select class="form-control" id="metricType" required>
                                <option value="">Select Metric Type</option>
                                <option value="QUEUE_LENGTH">Queue Length</option>
                                <option value="PROCESSING_TIME">Processing Time</option>
                                <option value="ROUTING_TIME">Routing Time</option>
                                <option value="DELIVERY_TIME">Delivery Time</option>
                                <option value="MESSAGE_COUNT">Message Count</option>
                                <option value="ERROR_RATE">Error Rate</option>
                                <option value="TOPIC_ACTIVITY">Topic Activity</option>
                                <option value="AGENT_ACTIVITY">Agent Activity</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="comparison" class="form-label">Comparison</label>
                            <select class="form-control" id="comparison" required>
                                <option value="">Select Comparison</option>
                                <option value="GT">Greater Than</option>
                                <option value="LT">Less Than</option>
                                <option value="GTE">Greater Than or Equal</option>
                                <option value="LTE">Less Than or Equal</option>
                                <option value="EQ">Equal</option>
                                <option value="NEQ">Not Equal</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="threshold" class="form-label">Threshold</label>
                            <input type="number" class="form-control" id="threshold" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="severity" class="form-label">Severity</label>
                            <select class="form-control" id="severity" required>
                                <option value="">Select Severity</option>
                                <option value="INFO">Info</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="enabled" class="form-label">Status</label>
                            <select class="form-control" id="enabled" required>
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Channels</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailNotification">
                            <label class="form-check-label" for="emailNotification">
                                Email Notification
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dashboardNotification" checked>
                            <label class="form-check-label" for="dashboardNotification">
                                Dashboard Notification
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="emailRecipientsSection" style="display: none;">
                        <label for="emailRecipients" class="form-label">Email Recipients</label>
                        <input type="text" class="form-control" id="emailRecipients"
                            placeholder="Comma-separated email addresses">
                        <small class="form-text text-muted">Enter email addresses separated by commas</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAlertConfig">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Details Modal -->
<div class="modal fade" id="alertDetailsModal" tabindex="-1" aria-labelledby="alertDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertDetailsModalLabel">Alert Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="alertDetailsContent">
                <!-- Alert details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="acknowledgeAlert">Acknowledge</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize date pickers with default values
    document.addEventListener('DOMContentLoaded', function () {
        // Set default date range for history tab (last 24 hours)
        const now = new Date();
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);

        document.getElementById('historyEndDate').value = now.toISOString().slice(0, 16);
        document.getElementById('historyStartDate').value = yesterday.toISOString().slice(0, 16);

        // Load initial data
        loadActiveAlerts();
        loadAlertConfigurations();

        // Add event listeners for tab changes
        document.getElementById('history-tab').addEventListener('click', function () {
            loadAlertHistory();
        });

        // Add event listeners for filters
        document.getElementById('applyFilters').addEventListener('click', loadActiveAlerts);
        document.getElementById('resetFilters').addEventListener('click', resetActiveFilters);
        document.getElementById('applyHistoryFilters').addEventListener('click', loadAlertHistory);

        // Add event listener for create alert button
        document.getElementById('createAlertConfig').addEventListener('click', showCreateAlertModal);

        // Add event listener for save alert config button
        document.getElementById('saveAlertConfig').addEventListener('click', saveAlertConfig);

        // Add event listener for acknowledge alert button
        document.getElementById('acknowledgeAlert').addEventListener('click', acknowledgeAlert);

        // Add event listener for email notification checkbox
        document.getElementById('emailNotification').addEventListener('change', function () {
            document.getElementById('emailRecipientsSection').style.display = this.checked ? 'block' : 'none';
        });
    });

    // Load active alerts
    function loadActiveAlerts() {
        const severityFilter = document.getElementById('severityFilter').value;
        const metricTypeFilter = document.getElementById('metricTypeFilter').value;

        let url = '/api/alerts/active';
        const params = [];

        if (severityFilter) {
            params.push(`severity=${severityFilter}`);
        }

        if (metricTypeFilter) {
            params.push(`metric_type=${metricTypeFilter}`);
        }

        if (params.length > 0) {
            url += '?' + params.join('&');
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayActiveAlerts(data);
            })
            .catch(error => {
                console.error('Error loading active alerts:', error);
                document.getElementById('activeAlerts').innerHTML = '<div class="alert alert-danger">Error loading alerts. Please try again later.</div>';
            });
    }

    // Display active alerts
    function displayActiveAlerts(alerts) {
        const container = document.getElementById('activeAlerts');

        if (alerts.length === 0) {
            container.innerHTML = '<div class="alert alert-success">No active alerts at this time.</div>';
            return;
        }

        let html = '';

        alerts.forEach(alert => {
            const alertConfig = alert.alert_configuration || {};
            const severity = alertConfig.severity || 'INFO';

            html += `
                <div class="card alert-card ${severity.toLowerCase()}">
                    <div class="card-body">
                        <div class="alert-header">
                            <h5 class="card-title">${alertConfig.name || 'Unnamed Alert'}</h5>
                            <span class="badge bg-${getSeverityClass(severity)}">${severity}</span>
                        </div>
                        <p class="card-text">${alert.message}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Triggered: ${formatDateTime(alert.timestamp)}</small>
                            <div class="alert-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="showAlertDetails('${alert.id}')">Details</button>
                                <button class="btn btn-sm btn-outline-success" onclick="acknowledgeAlertById('${alert.id}')">Acknowledge</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Load alert history
    function loadAlertHistory(page = 1) {
        const startDate = document.getElementById('historyStartDate').value;
        const endDate = document.getElementById('historyEndDate').value;
        const severity = document.getElementById('historySeverityFilter').value;
        const acknowledged = document.getElementById('acknowledgedFilter').value;

        let url = `/api/alerts/history?limit=10&offset=${(page - 1) * 10}`;

        if (startDate) {
            url += `&start_time=${encodeURIComponent(startDate)}`;
        }

        if (endDate) {
            url += `&end_time=${encodeURIComponent(endDate)}`;
        }

        if (severity) {
            url += `&severity=${severity}`;
        }

        if (acknowledged !== '') {
            url += `&acknowledged=${acknowledged}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayAlertHistory(data, page);
            })
            .catch(error => {
                console.error('Error loading alert history:', error);
                document.getElementById('alertHistory').innerHTML = '<div class="alert alert-danger">Error loading alert history. Please try again later.</div>';
            });
    }

    // Display alert history
    function displayAlertHistory(alerts, currentPage) {
        const container = document.getElementById('alertHistory');

        if (alerts.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No alerts found for the selected filters.</div>';
            document.getElementById('historyPagination').innerHTML = '';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-striped">';
        html += `
            <thead>
                <tr>
                    <th>Alert Name</th>
                    <th>Message</th>
                    <th>Severity</th>
                    <th>Timestamp</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;

        alerts.forEach(alert => {
            const alertConfig = alert.alert_configuration || {};
            const severity = alertConfig.severity || 'INFO';

            html += `
                <tr>
                    <td>${alertConfig.name || 'Unnamed Alert'}</td>
                    <td>${alert.message}</td>
                    <td><span class="badge bg-${getSeverityClass(severity)}">${severity}</span></td>
                    <td>${formatDateTime(alert.timestamp)}</td>
                    <td>${alert.acknowledged ? 'Acknowledged' : 'Unacknowledged'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAlertDetails('${alert.id}')">Details</button>
                        ${!alert.acknowledged ? `<button class="btn btn-sm btn-outline-success" onclick="acknowledgeAlertById('${alert.id}')">Acknowledge</button>` : ''}
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

        // Generate pagination
        generatePagination(currentPage, Math.ceil(alerts.length / 10));
    }

    // Generate pagination
    function generatePagination(currentPage, totalPages) {
        const pagination = document.getElementById('historyPagination');

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';

        // Previous button
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAlertHistory(${currentPage - 1}); return false;">Previous</a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadAlertHistory(${i}); return false;">${i}</a>
                </li>
            `;
        }

        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAlertHistory(${currentPage + 1}); return false;">Next</a>
            </li>
        `;

        pagination.innerHTML = html;
    }

    // Load alert configurations
    function loadAlertConfigurations() {
        fetch('/api/alerts/configurations')
            .then(response => response.json())
            .then(data => {
                displayAlertConfigurations(data);
            })
            .catch(error => {
                console.error('Error loading alert configurations:', error);
                document.getElementById('alertConfigurations').innerHTML = '<div class="alert alert-danger">Error loading alert configurations. Please try again later.</div>';
            });
    }

    // Display alert configurations
    function displayAlertConfigurations(configs) {
        const container = document.getElementById('alertConfigurations');

        if (configs.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No alert configurations found. Click "Create New Alert" to create one.</div>';
            return;
        }

        let html = '';

        configs.forEach(config => {
            html += `
                <div class="card config-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${config.name}</h5>
                        <div>
                            <span class="badge bg-${config.enabled ? 'success' : 'secondary'} me-2">${config.enabled ? 'Enabled' : 'Disabled'}</span>
                            <span class="badge bg-${getSeverityClass(config.severity)}">${config.severity}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${config.description || 'No description'}</p>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Metric Type:</strong> ${formatMetricType(config.metric_type)}
                            </div>
                            <div class="col-md-4">
                                <strong>Condition:</strong> ${formatComparison(config.comparison)} ${config.threshold}
                            </div>
                            <div class="col-md-4">
                                <strong>Notifications:</strong> ${formatNotificationChannels(config.notification_channels)}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editAlertConfig('${config.id}')">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAlertConfig('${config.id}')">Delete</button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Show alert details
    function showAlertDetails(alertId) {
        fetch(`/api/alerts/history?alert_id=${alertId}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    console.error('Alert not found');
                    return;
                }

                const alert = data[0];
                const alertConfig = alert.alert_configuration || {};
                const severity = alertConfig.severity || 'INFO';

                let html = `
                    <div class="alert alert-${getSeverityClass(severity)}">
                        <h5>${alertConfig.name || 'Unnamed Alert'}</h5>
                        <p>${alert.message}</p>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Alert ID:</strong> ${alert.id}
                        </div>
                        <div class="col-md-6">
                            <strong>Configuration ID:</strong> ${alert.alert_configuration_id || 'N/A'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Timestamp:</strong> ${formatDateTime(alert.timestamp)}
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong> ${alert.acknowledged ? 'Acknowledged' : 'Unacknowledged'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Severity:</strong> ${severity}
                        </div>
                        <div class="col-md-6">
                            <strong>Value:</strong> ${alert.value}
                        </div>
                    </div>
                `;

                if (alert.acknowledged) {
                    html += `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Acknowledged By:</strong> ${alert.acknowledged_by || 'N/A'}
                            </div>
                            <div class="col-md-6">
                                <strong>Acknowledged At:</strong> ${formatDateTime(alert.acknowledged_at)}
                            </div>
                        </div>
                    `;
                }

                if (alertConfig.description) {
                    html += `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>Description:</strong> ${alertConfig.description}
                            </div>
                        </div>
                    `;
                }

                if (alert.metadata) {
                    html += `
                        <div class="row mb-3">
                            <div class="col-12">
                                <strong>Metadata:</strong>
                                <pre>${JSON.stringify(alert.metadata, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('alertDetailsContent').innerHTML = html;

                // Show/hide acknowledge button based on alert status
                document.getElementById('acknowledgeAlert').style.display = alert.acknowledged ? 'none' : 'block';
                document.getElementById('acknowledgeAlert').dataset.alertId = alert.id;

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('alertDetailsModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading alert details:', error);
            });
    }

    // Show create alert modal
    function showCreateAlertModal() {
        // Reset form
        document.getElementById('alertConfigForm').reset();
        document.getElementById('alertConfigId').value = '';
        document.getElementById('emailRecipientsSection').style.display = 'none';

        // Update modal title
        document.getElementById('alertConfigModalLabel').textContent = 'Create Alert Configuration';

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('alertConfigModal'));
        modal.show();
    }

    // Edit alert configuration
    function editAlertConfig(configId) {
        fetch(`/api/alerts/configurations/${configId}`)
            .then(response => response.json())
            .then(config => {
                // Populate form
                document.getElementById('alertConfigId').value = config.id;
                document.getElementById('alertName').value = config.name;
                document.getElementById('alertDescription').value = config.description || '';
                document.getElementById('metricType').value = config.metric_type;
                document.getElementById('comparison').value = config.comparison;
                document.getElementById('threshold').value = config.threshold;
                document.getElementById('severity').value = config.severity;
                document.getElementById('enabled').value = config.enabled.toString();

                // Set notification channels
                const notificationChannels = config.notification_channels || {};
                document.getElementById('emailNotification').checked = !!notificationChannels.email;
                document.getElementById('dashboardNotification').checked = !!notificationChannels.dashboard;

                // Show/hide email recipients section
                document.getElementById('emailRecipientsSection').style.display = notificationChannels.email ? 'block' : 'none';

                // Set email recipients
                if (notificationChannels.email && notificationChannels.email.recipients) {
                    document.getElementById('emailRecipients').value = notificationChannels.email.recipients.join(', ');
                }

                // Update modal title
                document.getElementById('alertConfigModalLabel').textContent = 'Edit Alert Configuration';

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('alertConfigModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading alert configuration:', error);
            });
    }

    // Delete alert configuration
    function deleteAlertConfig(configId) {
        if (confirm('Are you sure you want to delete this alert configuration?')) {
            fetch(`/api/alerts/configurations/${configId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadAlertConfigurations();
                    } else {
                        alert('Failed to delete alert configuration');
                    }
                })
                .catch(error => {
                    console.error('Error deleting alert configuration:', error);
                    alert('Failed to delete alert configuration');
                });
        }
    }

    // Save alert configuration
    function saveAlertConfig() {
        // Get form values
        const configId = document.getElementById('alertConfigId').value;
        const name = document.getElementById('alertName').value;
        const description = document.getElementById('alertDescription').value;
        const metricType = document.getElementById('metricType').value;
        const comparison = document.getElementById('comparison').value;
        const threshold = parseFloat(document.getElementById('threshold').value);
        const severity = document.getElementById('severity').value;
        const enabled = document.getElementById('enabled').value === 'true';

        // Get notification channels
        const emailNotification = document.getElementById('emailNotification').checked;
        const dashboardNotification = document.getElementById('dashboardNotification').checked;

        // Build notification channels object
        const notificationChannels = {};

        if (emailNotification) {
            const emailRecipients = document.getElementById('emailRecipients').value;
            notificationChannels.email = {
                recipients: emailRecipients.split(',').map(email => email.trim()).filter(email => email)
            };
        }

        if (dashboardNotification) {
            notificationChannels.dashboard = {
                enabled: true
            };
        }

        // Build request data
        const data = {
            name,
            description,
            metric_type: metricType,
            comparison,
            threshold,
            severity,
            enabled,
            notification_channels: notificationChannels
        };

        // Determine if this is a create or update operation
        const method = configId ? 'PUT' : 'POST';
        const url = configId ? `/api/alerts/configurations/${configId}` : '/api/alerts/configurations';

        // Send request
        fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('alertConfigModal'));
                modal.hide();

                // Reload alert configurations
                loadAlertConfigurations();
            })
            .catch(error => {
                console.error('Error saving alert configuration:', error);
                alert('Failed to save alert configuration');
            });
    }

    // Acknowledge alert
    function acknowledgeAlert() {
        const alertId = document.getElementById('acknowledgeAlert').dataset.alertId;
        acknowledgeAlertById(alertId);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('alertDetailsModal'));
        modal.hide();
    }

    // Acknowledge alert by ID
    function acknowledgeAlertById(alertId) {
        fetch(`/api/alerts/acknowledge/${alertId}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                // Reload active alerts and alert history
                loadActiveAlerts();
                if (document.getElementById('history-tab').classList.contains('active')) {
                    loadAlertHistory();
                }
            })
            .catch(error => {
                console.error('Error acknowledging alert:', error);
                alert('Failed to acknowledge alert');
            });
    }

    // Reset active filters
    function resetActiveFilters() {
        document.getElementById('severityFilter').value = '';
        document.getElementById('metricTypeFilter').value = '';
        loadActiveAlerts();
    }

    // Format date time
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return 'N/A';
        const date = new Date(dateTimeStr);
        return date.toLocaleString();
    }

    // Get severity class
    function getSeverityClass(severity) {
        switch (severity) {
            case 'INFO':
                return 'info';
            case 'WARNING':
                return 'warning';
            case 'ERROR':
                return 'danger';
            case 'CRITICAL':
                return 'dark';
            default:
                return 'secondary';
        }
    }

    // Format metric type
    function formatMetricType(metricType) {
        if (!metricType) return 'Unknown';

        // Convert SNAKE_CASE to Title Case
        return metricType.split('_').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ');
    }

    // Format comparison
    function formatComparison(comparison) {
        if (!comparison) return '';

        switch (comparison) {
            case 'GT':
                return '>';
            case 'LT':
                return '<';
            case 'GTE':
                return '≥';
            case 'LTE':
                return '≤';
            case 'EQ':
                return '=';
            case 'NEQ':
                return '≠';
            default:
                return comparison;
        }
    }

    // Format notification channels
    function formatNotificationChannels(channels) {
        if (!channels) return 'None';

        const channelNames = [];
        if (channels.email) channelNames.push('Email');
        if (channels.dashboard) channelNames.push('Dashboard');

        return channelNames.join(', ') || 'None';
    }
</script>
{% endblock %}